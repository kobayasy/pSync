<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="1005px" preserveAspectRatio="none" style="width:566px;height:1005px;background:#FFFFFF;" version="1.1" viewBox="0 0 566 1005" width="566px" zoomAndPan="magnify"><defs/><g><rect height="26.2969" style="stroke:#00000000;stroke-width:1.0;fill:none;" width="121" x="221" y="10"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="111" x="226" y="27.9951">pSp1 protocol</text><rect height="77.3984" style="stroke:#000000;stroke-width:1.5;fill:none;" width="350" x="150" y="229.8828"/><rect height="602.3281" style="stroke:#000000;stroke-width:1.5;fill:none;" width="511" x="9" y="321.2813"/><rect height="542.0625" style="stroke:#000000;stroke-width:1.5;fill:none;" width="491" x="19" y="374.5469"/><rect height="77.3984" style="stroke:#000000;stroke-width:1.5;fill:none;" width="350" x="150" y="462.9453"/><rect height="77.3984" style="stroke:#000000;stroke-width:1.5;fill:none;" width="350" x="150" y="718.0078"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="202" x2="202" y1="89.8906" y2="998.875"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="438" x2="438" y1="204.0859" y2="998.875"/><rect fill="#E2E2F0" height="46.5938" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="84" x="160" y="42.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="70" x="167" y="62.292">Local host</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="57" x="173.5" y="78.5889">(Master)</text><path d="M207,104.8906 L207,159.8906 L559,159.8906 L559,114.8906 L549,104.8906 L207,104.8906 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M549,104.8906 L549,114.8906 L559,114.8906 L549,104.8906 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="305" x="213" y="121.9575">stdin: Send sync data from local host to remote</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="331" x="213" y="137.0903">stdout: Receive sync data from remote host to local</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="306" x="213" y="152.2231">stderr: Receive status from remote host to local</text><line style="stroke:#181818;stroke-width:1.0;" x1="384" x2="374" y1="201.5547" y2="197.5547"/><line style="stroke:#181818;stroke-width:1.0;" x1="384" x2="374" y1="201.5547" y2="205.5547"/><line style="stroke:#181818;stroke-width:1.0;" x1="202" x2="385" y1="201.5547" y2="201.5547"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="53" x="209" y="181.356">Connect</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="156" x="209" y="196.4888">(ssh ... 'psync --remote')</text><rect fill="#E2E2F0" height="46.5938" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="104" x="386" y="165.2891"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="90" x="393" y="185.2842">Remote host</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="46" x="415" y="201.5811">(Slave)</text><path d="M150,229.8828 L220,229.8828 L220,237.0156 L210,247.0156 L150,247.0156 L150,229.8828 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="77.3984" style="stroke:#000000;stroke-width:1.5;" width="350" x="150" y="229.8828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="25" x="165" y="242.9497">par</text><line style="stroke:#181818;stroke-width:1.0;" x1="436" x2="426" y1="268.1484" y2="264.1484"/><line style="stroke:#181818;stroke-width:1.0;" x1="436" x2="426" y1="268.1484" y2="272.1484"/><line style="stroke:#181818;stroke-width:1.0;" x1="202" x2="437" y1="268.1484" y2="268.1484"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="117" x="209" y="263.0825">protocol-ID: 'pSp1'</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="150" x2="500" y1="277.1484" y2="277.1484"/><line style="stroke:#181818;stroke-width:1.0;" x1="202" x2="212" y1="299.2813" y2="295.2813"/><line style="stroke:#181818;stroke-width:1.0;" x1="202" x2="212" y1="299.2813" y2="303.2813"/><line style="stroke:#181818;stroke-width:1.0;" x1="202" x2="437" y1="299.2813" y2="299.2813"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="117" x="219" y="294.2153">protocol-ID: 'pSp1'</text><path d="M9,321.2813 L86,321.2813 L86,328.4141 L76,338.4141 L9,338.4141 L9,321.2813 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="602.3281" style="stroke:#000000;stroke-width:1.5;" width="511" x="9" y="321.2813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="32" x="24" y="334.3481">loop</text><line style="stroke:#181818;stroke-width:1.0;" x1="436" x2="426" y1="359.5469" y2="355.5469"/><line style="stroke:#181818;stroke-width:1.0;" x1="436" x2="426" y1="359.5469" y2="363.5469"/><line style="stroke:#181818;stroke-width:1.0;" x1="202" x2="437" y1="359.5469" y2="359.5469"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="47" x="209" y="354.481">sync-ID</text><path d="M19,374.5469 L83,374.5469 L83,381.6797 L73,391.6797 L19,391.6797 L19,374.5469 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="542.0625" style="stroke:#000000;stroke-width:1.5;" width="491" x="19" y="374.5469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="34" y="387.6138">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="182" x="98" y="386.7573">[Remote have same sync-ID]</text><line style="stroke:#181818;stroke-width:1.0;" x1="202" x2="212" y1="412.8125" y2="408.8125"/><line style="stroke:#181818;stroke-width:1.0;" x1="202" x2="212" y1="412.8125" y2="416.8125"/><line style="stroke:#181818;stroke-width:1.0;" x1="202" x2="437" y1="412.8125" y2="412.8125"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="26" x="219" y="407.7466">ACK</text><path d="M157,425.8125 L157,450.8125 L482,450.8125 L482,435.8125 L472,425.8125 L157,425.8125 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M472,425.8125 L472,435.8125 L482,435.8125 L472,425.8125 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="122" x="254" y="442.8794">Lock sync directory</text><path d="M150,462.9453 L220,462.9453 L220,470.0781 L210,480.0781 L150,480.0781 L150,462.9453 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="77.3984" style="stroke:#000000;stroke-width:1.5;" width="350" x="150" y="462.9453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="25" x="165" y="476.0122">par</text><line style="stroke:#181818;stroke-width:1.0;" x1="436" x2="426" y1="501.2109" y2="497.2109"/><line style="stroke:#181818;stroke-width:1.0;" x1="436" x2="426" y1="501.2109" y2="505.2109"/><line style="stroke:#181818;stroke-width:1.0;" x1="202" x2="437" y1="501.2109" y2="501.2109"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="185" x="209" y="496.145">ACK (Sync directory is ready)</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="150" x2="500" y1="510.2109" y2="510.2109"/><line style="stroke:#181818;stroke-width:1.0;" x1="202" x2="212" y1="532.3438" y2="528.3438"/><line style="stroke:#181818;stroke-width:1.0;" x1="202" x2="212" y1="532.3438" y2="536.3438"/><line style="stroke:#181818;stroke-width:1.0;" x1="202" x2="437" y1="532.3438" y2="532.3438"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="185" x="219" y="527.2778">ACK (Sync directory is ready)</text><path d="M157,552.3438 L157,577.3438 L482,577.3438 L482,562.3438 L472,552.3438 L157,552.3438 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M472,552.3438 L472,562.3438 L482,562.3438 L472,552.3438 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="303" x="163.5" y="569.4106">Seek files in sync directory to make local file list</text><line style="stroke:#181818;stroke-width:1.0;" x1="202" x2="212" y1="603.6094" y2="599.6094"/><line style="stroke:#181818;stroke-width:1.0;" x1="202" x2="212" y1="603.6094" y2="607.6094"/><line style="stroke:#181818;stroke-width:1.0;" x1="202" x2="437" y1="603.6094" y2="603.6094"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="190" x="219" y="598.5435">Remote file list ← Local file list</text><path d="M29,616.6094 L29,641.6094 L374,641.6094 L374,626.6094 L364,616.6094 L29,616.6094 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M364,616.6094 L364,626.6094 L374,626.6094 L364,616.6094 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="324" x="35" y="633.6763">Merge file list local and remote to make synced list</text><line style="stroke:#181818;stroke-width:1.0;" x1="436" x2="426" y1="667.875" y2="663.875"/><line style="stroke:#181818;stroke-width:1.0;" x1="436" x2="426" y1="667.875" y2="671.875"/><line style="stroke:#181818;stroke-width:1.0;" x1="202" x2="437" y1="667.875" y2="667.875"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="91" x="209" y="662.8091">Synced file list</text><path d="M157,680.875 L157,705.875 L482,705.875 L482,690.875 L472,680.875 L157,680.875 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M472,680.875 L472,690.875 L482,690.875 L472,680.875 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="229" x="200.5" y="697.9419">Copy upload files to temporary area</text><path d="M150,718.0078 L220,718.0078 L220,725.1406 L210,735.1406 L150,735.1406 L150,718.0078 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="77.3984" style="stroke:#000000;stroke-width:1.5;" width="350" x="150" y="718.0078"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="25" x="165" y="731.0747">par</text><line style="stroke:#181818;stroke-width:1.0;" x1="436" x2="426" y1="756.2734" y2="752.2734"/><line style="stroke:#181818;stroke-width:1.0;" x1="436" x2="426" y1="756.2734" y2="760.2734"/><line style="stroke:#181818;stroke-width:1.0;" x1="202" x2="437" y1="756.2734" y2="756.2734"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="212" x="209" y="751.2075">Upload files from temporary area</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="150" x2="500" y1="765.2734" y2="765.2734"/><line style="stroke:#181818;stroke-width:1.0;" x1="202" x2="212" y1="787.4063" y2="783.4063"/><line style="stroke:#181818;stroke-width:1.0;" x1="202" x2="212" y1="787.4063" y2="791.4063"/><line style="stroke:#181818;stroke-width:1.0;" x1="202" x2="437" y1="787.4063" y2="787.4063"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="212" x="219" y="782.3403">Download files to temporary area</text><path d="M148,807.4063 L148,832.4063 L491,832.4063 L491,817.4063 L481,807.4063 L148,807.4063 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M481,807.4063 L481,817.4063 L491,817.4063 L481,807.4063 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="322" x="154" y="824.4731">Update files in sync directory from temporary area</text><path d="M157,842.5391 L157,867.5391 L482,867.5391 L482,852.5391 L472,842.5391 L157,842.5391 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M472,842.5391 L472,852.5391 L482,852.5391 L472,842.5391 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="207" x="211.5" y="859.606">Unlock synchronization directory</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="19" x2="510" y1="873.6719" y2="873.6719"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="218" x="24" y="883.8823">[Remote don't have same sync-ID]</text><line style="stroke:#181818;stroke-width:1.0;" x1="202" x2="212" y1="908.6094" y2="904.6094"/><line style="stroke:#181818;stroke-width:1.0;" x1="202" x2="212" y1="908.6094" y2="912.6094"/><line style="stroke:#181818;stroke-width:1.0;" x1="202" x2="437" y1="908.6094" y2="908.6094"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="27" x="219" y="903.5435">NAK</text><line style="stroke:#181818;stroke-width:1.0;" x1="436" x2="426" y1="951.7422" y2="947.7422"/><line style="stroke:#181818;stroke-width:1.0;" x1="436" x2="426" y1="951.7422" y2="955.7422"/><line style="stroke:#181818;stroke-width:1.0;" x1="202" x2="437" y1="951.7422" y2="951.7422"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="107" x="209" y="946.6763">No more sync-ID</text><line style="stroke:#181818;stroke-width:1.0;" x1="436" x2="426" y1="980.875" y2="976.875"/><line style="stroke:#181818;stroke-width:1.0;" x1="436" x2="426" y1="980.875" y2="984.875"/><line style="stroke:#181818;stroke-width:1.0;" x1="202" x2="437" y1="980.875" y2="980.875"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="209" y="975.8091">Disconnect</text><line style="stroke:#A80036;stroke-width:2.0;" x1="429" x2="447" y1="971.875" y2="989.875"/><line style="stroke:#A80036;stroke-width:2.0;" x1="429" x2="447" y1="989.875" y2="971.875"/><!--MD5=[6ac4df94082da3b421fbf2b314876431]
@startuml
title pSp1 protocol

hide footbox

participant "Local host\n(Master)" as local
participant "Remote host\n(Slave)" as remote

note right local
  stdin: Send sync data from local host to remote
  stdout: Receive sync data from remote host to local
  stderr: Receive status from remote host to local
end note
create remote
  local ->> remote: Connect\n(ssh ... 'psync - -remote')
  par
    local ->> remote: protocol-ID: 'pSp1'
  else
    local <<- remote: protocol-ID: 'pSp1'
  end
  loop
    local ->> remote: sync-ID
    alt Remote have same sync-ID
      local <<- remote: ACK
      note over local, remote
        Lock sync directory
      end note
      par
        local ->> remote: ACK (Sync directory is ready)
      else
        local <<- remote: ACK (Sync directory is ready)
      end
      note over local, remote
        Seek files in sync directory to make local file list
      end note
      local <<- remote: Remote file list ← Local file list
      note over local
        Merge file list local and remote to make synced list
      end note
      local ->> remote: Synced file list
      note over local, remote
        Copy upload files to temporary area
      end note
      par
        local ->> remote: Upload files from temporary area
      else
        local <<- remote: Download files to temporary area
      end
      note over local, remote
        Update files in sync directory from temporary area
      end note
      note over local, remote
        Unlock synchronization directory
      end note
    else Remote don't have same sync-ID
      local <<- remote: NAK
    end
  end
  local ->> remote: No more sync-ID
  local ->> remote: Disconnect
destroy remote

@enduml

PlantUML version 1.2022.4(Sat Apr 09 22:29:17 JST 2022)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) Client VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>